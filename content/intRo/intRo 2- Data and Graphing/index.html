---
title: "intRo 2- Data and Graphing"
author: "Billy Fryer with inspiration from Brendan Kent, Graham Pash, and Jason Thompson"
date: 2021-01-20
categories: ["R"]
tags: ["intRo Tutorials"]
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>Here is a link to the recorded version of this tutorial!</p>
<p><a href="https://www.youtube.com/watch?v=-ot2T-BPN1k&amp;list=PLzfY2UeNJip_GBjX8xEcRcc9omZjl1jFU&amp;index=2">intRo 2 Tutorial Link</a></p>
<div id="reading-in-csvs" class="section level1">
<h1>Reading in CSVs</h1>
<p>There are many ways to read in data sets. We are going to focus on CSVs since that is one of the most common data types found. CSV stands for Comma Separated Values. This that the data is <em>delimited</em> or separated with commas. These will eventually make up our columns. Using the <em>read_csv()</em> function from the tidyverse package is the easiest way to read in a csv.</p>
</div>
<div id="basics-of-web-scraping" class="section level1">
<h1>Basics of Web Scraping</h1>
<p>Web Scraping is a topic that seems big and scary, but actually isn’t as bad as one would think. Web Scraping is pulling data from the Internet so it can be used in a functional form. It is an individualized process however, meaning that you have to change the way you do it for every individual website. The example here is for the Kenpom website front page, one of the best sources for men’s college basketball information</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages --------------------------------------- tidyverse 1.3.1 --</code></pre>
<pre><code>## v ggplot2 3.3.5     v purrr   0.3.4
## v tibble  3.1.6     v dplyr   1.0.8
## v tidyr   1.2.0     v stringr 1.4.0
## v readr   2.1.2     v forcats 0.5.1</code></pre>
<pre><code>## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(rvest)</code></pre>
<pre><code>## 
## Attaching package: &#39;rvest&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:readr&#39;:
## 
##     guess_encoding</code></pre>
<pre class="r"><code>url &lt;- &quot;https://kenpom.com/&quot;
url %&gt;% 
  read_html() %&gt;% 
  html_table() -&gt; df

df &lt;- df[[1]]  %&gt;% # only want the first (main) table
  data.frame()

names(df) &lt;- df[1,] %&gt;% as.character # Assigning the first row as the headers
df &lt;- df[-1,] # Drops 1st row from data frame

# There are some random blank rows in the dataframe
df &lt;- df[!is.na(as.numeric(df$Rk)),] # drop column name rows</code></pre>
<pre><code>## Warning in `[.data.frame`(df, !is.na(as.numeric(df$Rk)), ): NAs introduced by
## coercion</code></pre>
<pre class="r"><code>row.names(df) &lt;- 1:nrow(df) # makes rownames the numbers 1:number of rows

# handle duplicate column names by renaming everything
names(df) &lt;- c(&#39;Rk&#39;,&#39;Team&#39;,&#39;Conf&#39;,&#39;W_L&#39;,&#39;AdjEM&#39;,&#39;AdjO&#39;,&#39;AdjO_Rk&#39;,&#39;AdjD&#39;,&#39;AdjD_Rk&#39;, &#39;AdjT&#39;,&#39;AdjT_Rk&#39;,&#39;Luck&#39;,&#39;Luck_Rk&#39;,&#39;OppAdjEM&#39;,&#39;OppAdjEM_Rk&#39;, &#39;OppO&#39;,&#39;OppO_Rk&#39;,&#39;OppD&#39;,&#39;OppD_Rk&#39;,&#39;NCAdjEM&#39;,&#39;NCAdjEM_Rk&#39;)

# subset only useful variables
df &lt;- df %&gt;% select(c(&#39;Rk&#39;,&#39;Team&#39;,&#39;Conf&#39;,&#39;W_L&#39;,&#39;AdjEM&#39;,&#39;AdjO&#39;,&#39;AdjD&#39;,&#39;AdjT&#39;,&#39;Luck&#39;, &#39;OppAdjEM&#39;,&#39;OppO&#39;,&#39;OppD&#39;,&#39;NCAdjEM&#39;))

# Change types to numeric

str(df)</code></pre>
<pre><code>## &#39;data.frame&#39;:    358 obs. of  13 variables:
##  $ Rk      : chr  &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ Team    : chr  &quot;Gonzaga 1&quot; &quot;Houston 5&quot; &quot;Kansas 1&quot; &quot;Baylor 1&quot; ...
##  $ Conf    : chr  &quot;WCC&quot; &quot;Amer&quot; &quot;B12&quot; &quot;B12&quot; ...
##  $ W_L     : chr  &quot;28-4&quot; &quot;32-6&quot; &quot;34-6&quot; &quot;27-7&quot; ...
##  $ AdjEM   : chr  &quot;+30.95&quot; &quot;+27.70&quot; &quot;+27.49&quot; &quot;+27.04&quot; ...
##  $ AdjO    : chr  &quot;120.7&quot; &quot;116.8&quot; &quot;119.2&quot; &quot;118.0&quot; ...
##  $ AdjD    : chr  &quot;89.7&quot; &quot;89.1&quot; &quot;91.7&quot; &quot;91.0&quot; ...
##  $ AdjT    : chr  &quot;72.5&quot; &quot;63.6&quot; &quot;69.3&quot; &quot;67.4&quot; ...
##  $ Luck    : chr  &quot;-.039&quot; &quot;-.012&quot; &quot;+.041&quot; &quot;+.004&quot; ...
##  $ OppAdjEM: chr  &quot;+4.24&quot; &quot;+5.89&quot; &quot;+12.60&quot; &quot;+10.96&quot; ...
##  $ OppO    : chr  &quot;104.6&quot; &quot;105.5&quot; &quot;108.0&quot; &quot;107.4&quot; ...
##  $ OppD    : chr  &quot;100.3&quot; &quot;99.6&quot; &quot;95.4&quot; &quot;96.5&quot; ...
##  $ NCAdjEM : chr  &quot;-2.88&quot; &quot;+0.18&quot; &quot;+4.13&quot; &quot;-1.89&quot; ...</code></pre>
<pre class="r"><code># We have a bunch of columns that are supposed to be numbers, 
# But they are character strings. We need to change that.

# This line of code applies the as.numeric() function to column
# 1 and columns 5 to 13 which makes them usable later. Ideally,
# We would use more tidyverse functions to make this better, but
# for now, it will do.
df[,c(1,5:13)] &lt;- sapply(df[,c(1,5:13)], as.numeric)

# Now let&#39;s look at the structure of df
str(df)</code></pre>
<pre><code>## &#39;data.frame&#39;:    358 obs. of  13 variables:
##  $ Rk      : num  1 2 3 4 5 6 7 8 9 10 ...
##  $ Team    : chr  &quot;Gonzaga 1&quot; &quot;Houston 5&quot; &quot;Kansas 1&quot; &quot;Baylor 1&quot; ...
##  $ Conf    : chr  &quot;WCC&quot; &quot;Amer&quot; &quot;B12&quot; &quot;B12&quot; ...
##  $ W_L     : chr  &quot;28-4&quot; &quot;32-6&quot; &quot;34-6&quot; &quot;27-7&quot; ...
##  $ AdjEM   : num  30.9 27.7 27.5 27 26 ...
##  $ AdjO    : num  121 117 119 118 119 ...
##  $ AdjD    : num  89.7 89.1 91.7 91 92.6 94.3 85 95.9 86.4 92.9 ...
##  $ AdjT    : num  72.5 63.6 69.3 67.4 72.2 67.5 66.5 67.3 67.4 62.3 ...
##  $ Luck    : num  -0.039 -0.012 0.041 0.004 0.048 -0.043 -0.031 -0.01 0.029 0.06 ...
##  $ OppAdjEM: num  4.24 5.89 12.6 10.96 6.45 ...
##  $ OppO    : num  105 106 108 107 106 ...
##  $ OppD    : num  100.3 99.6 95.4 96.5 99.5 ...
##  $ NCAdjEM : num  -2.88 0.18 4.13 -1.89 -0.78 -2.72 -8.24 -4.58 4.85 8.65 ...</code></pre>
<pre class="r"><code># Our variables are numbers</code></pre>
<p>We can go much more in depth about web scraping, but that would get very time consuming. It would be a better use of our time to look at data that is easier to access.</p>
</div>
<div id="packages-with-good-sports-data" class="section level1">
<h1>Packages with Good Sports Data</h1>
<p>I want to give credit to Brendan Kent’s Website <a href="https://brendankent.com" class="uri">https://brendankent.com</a> for the majority of these R packages mentioned. For a link to this specific article, check out <a href="https://brendankent.com/2021/03/09/free-sports-data-sources/" class="uri">https://brendankent.com/2021/03/09/free-sports-data-sources/</a>.</p>
<p>One of the unique things about R is that anyone can create a package and share it with others for public use on Github. Github is a code sharing platform that we will discuss more about in a future meeting. For now, we will learn how to get packages off of Github by using the devtools package.</p>
<pre class="r"><code># Install and load devtools package
#install.packages(&quot;devtools&quot;)
library(devtools)</code></pre>
<pre><code>## Loading required package: usethis</code></pre>
<pre class="r"><code># Use the devtools function install_github to install packages from github
# install_github(&quot;lbenz730/ncaahoopR&quot;)

library(ncaahoopR) # Then load it just as you would any other package</code></pre>
<p>If this is not working, look and see if your packages need updating. To do this, click on the packages tab on the right side of the screen and then click Update.</p>
<p>We will now discuss packages by sports. If any of these sound interesting to you, just look them up to see documentation and how to download them!</p>
<p><strong>Just a side note: There are a lot of puns using R in the names of packages. You have been warned.</strong></p>
<div id="american-football" class="section level2">
<h2>American Football</h2>
<ul>
<li>nflscrapR</li>
<li>nflfastR</li>
<li>NFLSimulatoR</li>
<li>cfbscrapR</li>
<li>ffsimulator</li>
</ul>
</div>
<div id="basketball" class="section level2">
<h2>Basketball</h2>
<ul>
<li>nbastatR</li>
<li>ncaahoopR</li>
<li>hoopR</li>
<li>wehoop</li>
<li>airball</li>
</ul>
</div>
<div id="baseball" class="section level2">
<h2>Baseball</h2>
<ul>
<li>baseballr</li>
<li>Lahman (availible on CRAN)</li>
</ul>
</div>
<div id="soccer" class="section level2">
<h2>Soccer</h2>
<ul>
<li>socceR</li>
<li>footballR</li>
<li>ggsoccer</li>
<li>worldfootballR</li>
<li>tyrone_mings</li>
</ul>
</div>
<div id="cricket" class="section level2">
<h2>Cricket</h2>
<ul>
<li>cricketr (availible on CRAN)</li>
</ul>
<p>For other sports, I again point you to Brendan Kent’s article <a href="https://brendankent.com/2021/03/09/free-sports-data-sources/" class="uri">https://brendankent.com/2021/03/09/free-sports-data-sources/</a>. More sports are included there as well as websites you could possible scrape from.</p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="graphing" class="section level1">
<h1>Graphing</h1>
<p>One of the most useful things that sports analysts do is create graphics. Graphics are simply easy ways do digest information. These include charts, small tables, and graphs. A great way of doing this is with the <code>ggplot2</code> package! Let’s do some examples based on the Kenpom data we scraped earlier.</p>
<div id="histogram-of-team-luck" class="section level2">
<h2>Histogram of Team Luck</h2>
<p>To Start, we will make use the <code>ggplot</code> function to give the data parameters. The first argument will be the name of the data frame we want to use.</p>
<p>The second argument, mapping, is normally the trickiest to wrap your head around. If you are mapping something <em>based on a value inside your data</em>, you must wrap it inside <code>aes()</code>. If you want to set something a <em>constant value</em>, it does not go inside <code>aes()</code>. For example, since we want to make a histogram based on the Luck variable, that needs to go inside an <code>aes()</code> statement. This construct applies later on as well inside of the <code>geom_***()</code> functions as well.</p>
<p>Finally, we are ready to make the actual graph. Depending on what we want, we would want to use the corresponding <code>geom_***()</code> function. Since we want a histogram, we use the <code>geom_histogram()</code> function. We can specify the number of bins we want with the <code>bins =</code> option. Since we want to specify this as a set number, we do not wrap it in a <code>aes()</code> function.</p>
<pre class="r"><code>ggplot(df, aes(x = Luck)) +
  geom_histogram(bins = 40)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Graphing%20Example%201-1.png" width="672" /></p>
</div>
<div id="upgrading-our-plot" class="section level2">
<h2>Upgrading our Plot</h2>
<p>If we want to add on to a plot, we can do that to! To add layers on to a plot, we put a + between layers. Plots can also be saved to an object which allows us to add on at different times. To see a plot after saving it, wrap it in a <code>print()</code> statement.</p>
<pre class="r"><code>ggplot(df, aes(x = Luck)) +
  geom_histogram(bins = 40)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Graphing%20Example%202-1.png" width="672" /></p>
<pre class="r"><code>luck_plot &lt;- ggplot(df, aes(x = Luck)) +
              geom_histogram(aes(y = ..density..),
                                 bins = 40)</code></pre>
<p>To add a title, subtitle, and caption use the <code>labs()</code> function.</p>
<pre class="r"><code>luck_plot2 &lt;- luck_plot +
  labs(title = &quot;NCAA Basketball Luck&quot;,
       subtitle = &quot;Current NCAA MBB Season&quot;,
       caption = &quot;Viz by Billy Fryer (@_b4billy_) ~ Data from kenpom.com&quot;)

print(luck_plot2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Graphing%20Example%203-1.png" width="672" /></p>
<p>If we want a density curve around the histogram, that’s easy too. We can even change the color to make it stand out more. Finally, to output the file to your computer, we use the <code>ggsave()</code> function</p>
<pre class="r"><code>luck_plot3 &lt;- luck_plot2 +
  # Add a Red Density curve
  geom_density(color = &quot;red&quot;,
               fill = &quot;yellow&quot;,
               alpha = .5) +
  # Center Title and subtitle
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

print(luck_plot3)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Graphing%20Example%204-1.png" width="672" /></p>
<pre class="r"><code>#ggsave(&quot;Luckiest Teams.png&quot;, luck_plot)</code></pre>
<p>The ggplot2 package is one of the best packages in R and there are tons of resources that one can learn more about it. For more information, search “ggplot2 cheat sheet” which gives more information about available plots in the package or “Tidy Tuesday” which is a R Community initiative to teach others about manipulating data with the <code>Tidyverse</code> package and plotting with <code>ggplot2</code>.</p>
</div>
</div>
<div id="graphing-in-groups" class="section level1">
<h1>Graphing in Groups</h1>
<p>There may be times where you want to group objects together and perform analysis on that. This is very useful when doing analysis where players may be represented in different rows, such as a pitch by pitch analysis in baseball. We will use the same data frame to group by Conference.</p>
<pre class="r"><code># Make a copy of df and call it df_by_conference
df_by_conference &lt;- df

df_by_conference &lt;- df_by_conference %&gt;% 
  # Group By Conference
  group_by(Conf) %&gt;% 
  # Summarize Statistics
  summarize( # Find Mean Rank by Conference
            Rk = mean(Rk, na.rm = TRUE),
            # Find Mean AdjEM by Conference
            AdjEM = mean(AdjEM, na.rm = TRUE)) %&gt;% 
  # Can&#39;t forget to Ungroup!
  ungroup() %&gt;% 
  # Add a Power 6 Column
  # ACC, SEC BIG 10, BIG 12, BIG EAST
  mutate(Power6 = case_when(Conf %in% c(&quot;ACC&quot;, &quot;SEC&quot;, &quot;B10&quot;, &quot;B12&quot;, &quot;BE&quot;, &quot;P12&quot;) ~ &quot;Power Conference&quot;,
                            TRUE ~ &quot;Non-Power Conference&quot;))

# Make Power6 a factor variable
df_by_conference$Power6 &lt;- factor(df_by_conference$Power6)</code></pre>
<p>Now that we have a new data set, it’s time to graph it!</p>
<pre class="r"><code># Give the df name then the x and y coordinates
ggplot(df_by_conference, aes(x = AdjEM,
                             y = Rk)) +
  # We want to color by whether or not they 
  # are a Power Conference, so we use the color = option
  # geom_point() plots data points
  geom_point(aes(color = Power6)) +
  # Labels
  labs(title = &quot;Conferences by Rank and AdjEM&quot;,
       # I didn&#39;t want to include a Legend Title
       color = &quot;&quot;,
       y = &quot;Rank&quot;, 
       x = &quot;Adjusted Efficiency Margin&quot;,
       # Give Credit to Yourself and the Data Source
       caption = &quot;Viz by Billy Fryer (@_b4billy_) | Data from kenpom.com&quot;) +
  # Centering the title
  theme(plot.title = element_text(hjust = 0.5)) +
  # Choosing colors. The # then the letters and numbers
  # Represents Hex Colors!
  scale_color_manual(values =  c(
                    &quot;Power Conference&quot; = &quot;#FF0000&quot;,
                     &quot;Non-Power Conference&quot; = &quot;#000000&quot;)
                    )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Grouping%20Graph%202-1.png" width="672" /></p>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>Many thanks again to Brendan Kent (Twitter: <span class="citation">@brendankent</span>, <span class="citation">@MeasurablesPod</span>), Graham Pash (Twitter: <span class="citation">@gtpash</span>), and Jason Thompson (Twitter: <span class="citation">@jason24thompson</span>) for allowing me to use some of their stuff. As a recap, we covered how to read in CSVs, some very basic webscraping, and learned more about packages that have sports data. More importantly, we learned how to make graphics in R using the <code>ggplot2</code> package.</p>
</div>
